services:

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped

  redis-database:
    container_name: redis-database
    hostname: redis-database
    image: redis:8.0-rc1
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping | grep PONG" ]
      interval: 10s
      retries: 5
      start_period: 5s
      timeout: 5s
    
  redis-insight:
    image: redis/redisinsight:latest
    container_name: redis-insight
    ports:
    - "5540:5540"
    depends_on:
      - redis-database

  google_workspace_mcp:
    build:
      context: ./google_workspace_mcp_server
      dockerfile: Dockerfile
    container_name: google_workspace_mcp
    ports:
      - "8001:8001"
    env_file:
      - .env
    environment:
      - APP_HOSTNAME=0.0.0.0
      - APP_PORT=8001
      - OAUTHLIB_INSECURE_TRANSPORT=1
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET}
      # Use disk storage for OAuth state persistence
      - WORKSPACE_MCP_OAUTH_PROXY_STORAGE_BACKEND=disk
      - WORKSPACE_MCP_OAUTH_PROXY_DISK_DIRECTORY=/app/.oauth-state
    volumes:
      - ./google_workspace_mcp_server/.credentials:/app/.credentials
      - ./google_workspace_mcp_server/.oauth-state:/app/.oauth-state
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/mcp || exit 1"]
      interval: 30s
      retries: 5
      start_period: 10s
      timeout: 10s

  b2b_agent:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./src:/app/src
      - ./main.py:/app/main.py
    env_file:
      - .env
    ports:
      - "7860:7860"
    environment:
      - PORT=7860
      # QDrant Configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_GRPC_PORT=6334
      - QDRANT_PREFER_GRPC=true
      - QDRANT_HTTPS=false
      - QDRANT_COLLECTION=leads
      - QDRANT_TIMEOUT=10.0
      - QDRANT_BATCH_SIZE=100
      # Google Workspace MCP Configuration
      - WORKSPACE_MCP_BASE_URI=http://google_workspace_mcp
      - WORKSPACE_MCP_PORT=8001
    depends_on:
      - qdrant
      - redis-database
      - google_workspace_mcp

volumes:
  qdrant_storage: